name: Cosmic Portfolio CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: üöÄ Checkout –∫–æ–¥–∞
        uses: actions/checkout@v4

      - name: ‚ö° –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      # 1. –£–ë–ï–î–ò–¢–ï–°–¨, –ß–¢–û GITHUB PAGES –í–ö–õ–Æ–ß–ï–ù–´ –í –ù–ê–°–¢–†–û–ô–ö–ê–• –†–ï–ü–û–ó–ò–¢–û–†–ò–Ø
      #    Settings ‚Üí Pages ‚Üí Branch: main, Folder: /(root)
      
      # 2. –°–ë–û–†–ö–ê –°–¢–ê–¢–ò–ß–ï–°–ö–ò–• –§–ê–ô–õ–û–í (–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û)
      - name: üèóÔ∏è –°–±–æ—Ä–∫–∞ —Å—Ç–∞—Ç–∏–∫–∏
        run: |
          # –î–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ HTML/CSS/JS —Å–∞–π—Ç–∞ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ—Å—Ç–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
          # –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å —Å–±–æ—Ä–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ npm), —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ:
          # npm install
          # npm run build
          mkdir -p ./build
          cp -r ./* ./build/ 2>/dev/null || :  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –µ—Å–ª–∏ –Ω–µ—Ç —Ñ–∞–π–ª–æ–≤
        # –ï—Å–ª–∏ —É –≤–∞—Å SPA –∏–ª–∏ —Å–ª–æ–∂–Ω—ã–π –ø—Ä–æ–µ–∫—Ç, –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à—É –∫–æ–º–∞–Ω–¥—É —Å–±–æ—Ä–∫–∏

      # 3. –ù–ê–°–¢–†–û–ô–ö–ê GITHUB PAGES
      - name: üõ†Ô∏è Setup GitHub Pages
        uses: actions/configure-pages@v3
      
      # 4. –ó–ê–ì–†–£–ó–ö–ê –ê–†–¢–ï–§–ê–ö–¢–û–í (–ö–õ–Æ–ß–ï–í–û–ô –®–ê–ì!)
      - name: ‚¨ÜÔ∏è Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: ./build  # –ü–∞–ø–∫–∞ —Å–æ —Å—Ç–∞—Ç–∏–∫–æ–π
      
      # 5. –î–ï–ü–õ–û–ô –ù–ê GITHUB PAGES
      - name: üì§ –î–µ–ø–ª–æ–π –Ω–∞ GitHub Pages
        uses: actions/deploy-pages@v2
        id: deployment

      # 6. Lighthouse –∞—É–¥–∏—Ç (–¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è!)
      - name: üîç –ê—É–¥–∏—Ç Lighthouse
        uses: treosh/lighthouse-ci-action@v9
        if: github.event_name == 'push' && success()
        with:
          urls: |
            ${{ steps.deployment.outputs.page_url }}
          temporaryPublicStorage: true
          configPath: ./lighthouserc.json
        env:
          LIGHTHOUSE_TOKEN: ${{ secrets.GITHUB_TOKEN }}
